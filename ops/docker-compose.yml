# AI Empire Docker Compose — Secure 24/7 Services
# Version: 1.0
# Last Updated: 2026-02-10

version: '3.8'

networks:
  empire-internal:
    driver: bridge
    internal: true  # No external internet access by default
  empire-vpn:
    driver: bridge  # Only exposed via Tailscale/Caddy

volumes:
  postgres-data:
  redis-data:
  openclaw-logs:

services:
  # PostgreSQL — CRM, task state, audit logs
  postgres:
    image: postgres:16-alpine
    container_name: empire-postgres
    restart: unless-stopped
    user: "1000:1000"  # Non-root
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/postgresql
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    networks:
      - empire-internal
    ports:
      - "127.0.0.1:5432:5432"  # Localhost only
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: aiempire
      POSTGRES_USER: empire
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U empire"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Redis — Task queue, session state
  redis:
    image: redis:7-alpine
    container_name: empire-redis
    restart: unless-stopped
    user: "1000:1000"  # Non-root
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - empire-internal
    ports:
      - "127.0.0.1:6379:6379"  # Localhost only
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --requirepass "${REDIS_PASSWORD}"
      --appendonly yes
      --appendfsync everysec
      --save 3600 1
      --save 300 100
      --save 60 10000
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  # OpenClaw — Agent orchestration platform
  openclaw:
    build:
      context: ../openclaw-config
      dockerfile: Dockerfile
    container_name: empire-openclaw
    restart: unless-stopped
    user: "1000:1000"  # Non-root
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - empire-internal
      - empire-vpn
    ports:
      - "127.0.0.1:18789:18789"  # Localhost only (exposed via Caddy)
    volumes:
      - openclaw-logs:/app/logs:rw
      - ../openclaw-config:/app/config:ro
    environment:
      REDIS_HOST: redis
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      POSTGRES_HOST: postgres
      POSTGRES_DB: aiempire
      POSTGRES_USER: empire
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      OLLAMA_HOST: host.docker.internal:11434
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Atomic Reactor — Task execution engine
  atomic-reactor:
    build:
      context: ../atomic-reactor
      dockerfile: Dockerfile
    container_name: empire-reactor
    restart: unless-stopped
    user: "1000:1000"  # Non-root
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - empire-internal
      - empire-vpn
    ports:
      - "127.0.0.1:8888:8888"  # Localhost only
    volumes:
      - ../atomic-reactor:/app:ro
    environment:
      REDIS_HOST: redis
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      OLLAMA_HOST: host.docker.internal:11434
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # CRM — Lead management & BANT scoring
  crm:
    build:
      context: ../crm
      dockerfile: Dockerfile
    container_name: empire-crm
    restart: unless-stopped
    user: "1000:1000"  # Non-root
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - empire-internal
      - empire-vpn
    ports:
      - "127.0.0.1:3500:3500"  # Localhost only
    volumes:
      - ../crm:/app:ro
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: aiempire
      POSTGRES_USER: empire
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      SESSION_SECRET: "${SESSION_SECRET}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3500/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Caddy — Reverse proxy with auto-TLS (VPN-facing)
  caddy:
    image: caddy:2-alpine
    container_name: empire-caddy
    restart: unless-stopped
    user: "1000:1000"  # Non-root (Caddy drops privileges)
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Bind to port 443
    networks:
      - empire-vpn
    ports:
      - "127.0.0.1:443:443"  # HTTPS (Tailscale VPN only)
      - "127.0.0.1:80:80"    # HTTP (redirect to HTTPS)
    volumes:
      - ./proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./proxy/caddy-data:/data:rw
      - ./proxy/caddy-config:/config:rw
    depends_on:
      - openclaw
      - atomic-reactor
      - crm
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 5s
      retries: 3

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
