name: "Gold Nugget Auto-Extractor"

on:
  push:
    branches: [main]
    paths:
      - 'gold-nuggets/**'
      - 'docs/**'
  schedule:
    # Taeglich 20:00 UTC (22:00 DE) - Gold Nugget Review
    - cron: '0 20 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  # ============================================
  # Extrahiere Gold Nuggets aus neuen Commits
  # ============================================
  extract-nuggets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "Count and Index Gold Nuggets"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const date = new Date().toISOString().split('T')[0];

            // List all gold nuggets
            let nuggetDir;
            try {
              const contents = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'gold-nuggets'
              });
              nuggetDir = contents.data.filter(f =>
                f.name.endsWith('.md') && !f.name.startsWith('._')
              );
            } catch (e) {
              console.log('No gold-nuggets directory found');
              return;
            }

            // Build index
            let indexContent = `# GOLD NUGGETS INDEX\n`;
            indexContent += `**Stand:** ${date}\n`;
            indexContent += `**Anzahl:** ${nuggetDir.length} Nuggets\n\n`;
            indexContent += `---\n\n`;
            indexContent += `| # | Nugget | Datei | Groesse |\n`;
            indexContent += `|---|--------|-------|--------|\n`;

            nuggetDir.forEach((file, i) => {
              const name = file.name.replace('.md', '').replace(/_/g, ' ');
              indexContent += `| ${i + 1} | ${name} | [${file.name}](${file.html_url}) | ${(file.size / 1024).toFixed(1)} KB |\n`;
            });

            indexContent += `\n---\n\n`;
            indexContent += `## Kategorien\n\n`;
            indexContent += `### Tech/AI\n`;
            nuggetDir.filter(f => f.name.includes('KIMI') || f.name.includes('AI') || f.name.includes('SWARM') || f.name.includes('OPENCLAW'))
              .forEach(f => { indexContent += `- [${f.name}](gold-nuggets/${f.name})\n`; });
            indexContent += `\n### Business/Revenue\n`;
            nuggetDir.filter(f => f.name.includes('MONETIZATION') || f.name.includes('EMPIRE') || f.name.includes('VISION'))
              .forEach(f => { indexContent += `- [${f.name}](gold-nuggets/${f.name})\n`; });
            indexContent += `\n### Tools/Integration\n`;
            nuggetDir.filter(f => f.name.includes('FRAMEWORK') || f.name.includes('GITHUB') || f.name.includes('REDPLANET') || f.name.includes('DEXTER'))
              .forEach(f => { indexContent += `- [${f.name}](gold-nuggets/${f.name})\n`; });

            indexContent += `\n---\n*Auto-generated by Gold Nugget Extractor*\n`;

            // Update index file
            let sha;
            try {
              const existing = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'gold-nuggets/INDEX.md'
              });
              sha = existing.data.sha;
            } catch (e) {}

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'gold-nuggets/INDEX.md',
              message: `[AUTO] Update Gold Nuggets Index (${nuggetDir.length} nuggets)`,
              content: Buffer.from(indexContent).toString('base64'),
              ...(sha ? { sha } : {})
            });

      - name: "Create Issue if new Nuggets detected"
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if gold-nuggets were added in this push
            const commits = context.payload.commits || [];
            const newNuggets = [];

            for (const commit of commits) {
              const added = commit.added || [];
              const nuggets = added.filter(f => f.startsWith('gold-nuggets/') && f.endsWith('.md'));
              newNuggets.push(...nuggets);
            }

            if (newNuggets.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[NUGGET] ${newNuggets.length} neue Gold Nuggets - Verarbeiten!`,
                body: `## Neue Gold Nuggets detected!\n\n${newNuggets.map(n => `- \`${n}\``).join('\n')}\n\n### Anweisungen:\n1. Lies jeden neuen Gold Nugget\n2. Extrahiere monetarisierbare Ideen\n3. Erstelle Produkt-Konzepte oder Content-Ideen\n4. Update \`docs/CHATGPT_TASKS.md\` mit neuen Tasks\n5. Erstelle Fiverr/Gumroad Listings basierend auf Nuggets`,
                labels: ['gold-nugget', 'auto-generated', 'revenue']
              });
            }
