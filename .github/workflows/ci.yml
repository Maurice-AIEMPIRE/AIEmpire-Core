name: CI Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python linting tools
        run: pip install flake8

      - name: Lint Python files
        run: flake8 --max-line-length=120 --count --show-source --statistics *.py || true

      - name: Check YAML syntax
        run: |
          pip install yamllint
          yamllint -d relaxed .github/workflows/ || true
          yamllint -d relaxed atomic-reactor/tasks/ || true

  security:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          # Check for common secret patterns
          if grep -rn "sk-[a-zA-Z0-9]\{20,\}" --include="*.py" --include="*.js" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v ".env.example"; then
            echo "::warning::Potential API key found in code"
          fi
          if grep -rn "AKIA[A-Z0-9]\{16\}" --include="*.py" --include="*.js" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v node_modules; then
            echo "::warning::Potential AWS key found in code"
          fi
          echo "Secret scan complete"

      - name: Check .env not committed
        run: |
          if [ -f .env ]; then
            echo "::error::.env file found in repository!"
            exit 1
          fi
          echo ".env check passed"

  build:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Python syntax check
        run: python -m py_compile claude_failover_system.py && python -m py_compile github_control_interface.py && python -m py_compile x_auto_poster.py

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CRM dependencies
        working-directory: crm
        run: npm install --ignore-scripts

      - name: Validate Docker Compose files
        run: |
          for f in $(find . -name "docker-compose.yaml" -o -name "docker-compose.yml"); do
            echo "Validating $f..."
            docker compose -f "$f" config > /dev/null 2>&1 || echo "::warning::Invalid compose file: $f"
          done
