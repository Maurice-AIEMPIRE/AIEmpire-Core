name: Claude Health Check

on:
  schedule:
    # Check every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  check-claude:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install aiohttp
          
      - name: Check Claude API
        id: claude-check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 claude_failover_system.py
          
      - name: Create Failover Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'claude-failover',
              state: 'open'
            });
            
            // Only create if no open failover issue exists
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”„ Claude API Limit Reached - GitHub Mode Active',
                body: `# Claude API Failover Activated\n\n**Time:** ${new Date().toISOString()}\n**Status:** Claude API unavailable or at limit\n**Mode:** GitHub Control Mode\n\n## What This Means\nThe system has automatically switched to GitHub-based control because Claude API is not available.\n\n## Available Commands\nAll operations now work through GitHub Issues:\n- \`@bot status\` - System status\n- \`@bot generate-content\` - Generate X content\n- \`@bot run-task <task>\` - Run tasks\n- \`@bot revenue-report\` - Revenue status\n\n## Automatic Recovery\nThe system checks Claude API every 30 minutes and will automatically switch back when available.\n\n## Manual Actions\nYou can manually trigger workflows from the Actions tab.`,
                labels: ['claude-failover', 'system-control', 'automation']
              });
            }
