name: Nightly Health Check

on:
  schedule:
    # Run every day at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check repository structure
        run: |
          echo "ðŸ“ Checking repository structure..."
          
          # Check for required directories
          REQUIRED_DIRS=("apps" "services" "agents" "infra" "docs" "playbooks" "templates")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir exists"
            else
              echo "âš ï¸  $dir missing"
            fi
          done

      - name: Validate configuration files
        run: |
          echo "ðŸ” Validating configuration files..."
          
          # Validate JSON files
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./venv/*" | while read file; do
            if python -m json.tool "$file" > /dev/null 2>&1; then
              echo "âœ… Valid JSON: $file"
            else
              echo "âŒ Invalid JSON: $file"
            fi
          done

      - name: Check Docker Compose files
        run: |
          echo "ðŸ³ Checking Docker Compose files..."
          
          find . -name "docker-compose*.y*ml" -not -path "./node_modules/*" | while read file; do
            if docker compose -f "$file" config > /dev/null 2>&1; then
              echo "âœ… Valid Compose: $file"
            else
              echo "âŒ Invalid Compose: $file"
            fi
          done

      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for secrets..."
          
          # Simple secret patterns to check
          if git grep -iE "(api[_-]?key|secret|password|token)\s*=\s*['\"][^'\"]{8,}" -- '*.py' '*.js' '*.json' '*.yaml' '*.yml' ':!.github'; then
            echo "âš ï¸  Potential secrets found in code!"
          else
            echo "âœ… No obvious secrets found"
          fi

      - name: Check dependencies for vulnerabilities
        run: |
          echo "ðŸ›¡ï¸ Checking dependencies..."
          
          # Check npm dependencies if package.json exists
          if [ -f "crm/package.json" ]; then
            cd crm
            npm audit --production || echo "âš ï¸  npm audit found issues"
            cd ..
          fi

      - name: Generate health report
        run: |
          echo "ðŸ“Š Generating health report..."
          
          cat > health-report.md << EOF
          # System Health Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Repository Stats
          
          - Total files: $(find . -type f -not -path "./.git/*" | wc -l)
          - Total lines: $(find . -name "*.py" -o -name "*.js" -o -name "*.md" | xargs wc -l | tail -1)
          - Last commit: $(git log -1 --pretty=format:"%h - %s (%cr)")
          
          ## Directory Structure
          
          \`\`\`
          $(tree -L 2 -d -I 'node_modules|venv|.git' || find . -maxdepth 2 -type d)
          \`\`\`
          
          ## Next Steps
          
          - Review any warnings above
          - Check for pending issues
          - Update documentation if needed
          
          ---
          Generated by GitHub Actions
          EOF
          
          cat health-report.md

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.md
          retention-days: 30
