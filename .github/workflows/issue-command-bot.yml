name: Issue Command Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  process-command:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install aiohttp pyyaml
          
      - name: Process Command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment?.body || context.payload.issue?.body || '';
            const issueNumber = context.payload.issue.number;
            
            console.log('Processing comment:', comment);
            console.log('Issue number:', issueNumber);
            
            // Check for bot commands
            if (comment.includes('@bot status')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `# System Status\n\n**Mode:** GitHub Control\n**Timestamp:** ${new Date().toISOString()}\n**Services:**\n- GitHub Actions Active\n- Content Generation Ready\n- Kimi API Available\n- X Lead Machine Ready\n- CRM System Standby\n\n**Commands Available:**\n- \`@bot generate-content\` - Generate X/Twitter content\n- \`@bot status\` - Show this status\n- \`@bot run-task <task>\` - Run specific task\n- \`@bot revenue-report\` - Show revenue status`
              });
            }
            
            if (comment.includes('@bot generate-content')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'ðŸš€ Generating content... Check workflow run for results.'
              });
              
              // Trigger content generation workflow
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auto-content-generation.yml',
                ref: 'main'
              });
            }
            
            if (comment.includes('@bot revenue-report')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `# Revenue Report\n\n**Current Status:** EUR 0\n**Target:** EUR 50-100 overnight\n\n**Revenue Streams:**\n1. Gumroad - 1 product live (EUR 27)\n2. Fiverr - No gigs yet\n3. X/Twitter - Content ready, not posted\n4. Telegram - No bot yet\n\n**Next Actions:**\n1. Post X content to generate leads\n2. Create Fiverr gigs\n3. Set up Telegram bot\n4. Launch additional Gumroad products`
              });
            }
