name: "24/7 Content Engine"

on:
  schedule:
    # Morgens 06:00 UTC (08:00 DE) - Trends + Content
    - cron: '0 6 * * *'
    # Mittags 10:00 UTC (12:00 DE) - Products + Gigs
    - cron: '0 10 * * *'
    # Abends 16:00 UTC (18:00 DE) - Social Media + Engagement
    - cron: '0 16 * * *'
    # Nachts 22:00 UTC (00:00 DE) - Research + Analysis
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      task_block:
        description: 'Which block to run (A1/A2/A3/B1/B2/D1/D2/D3/ALL)'
        required: false
        default: 'ALL'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ============================================
  # JOB 1: MORNING - Trends + Content (08:00 DE)
  # ============================================
  morning-content:
    if: github.event.schedule == '0 6 * * *' || github.event.inputs.task_block == 'ALL' || github.event.inputs.task_block == 'A3'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Generate Daily Twitter Posts"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const dayOfWeek = new Date().getDay();

            // Kategorien rotieren nach Wochentag
            const categories = [
              'AI Automation Tips (EN)',
              'BMA + AI Integration (DE)',
              'OpenClaw Tutorial Thread',
              'Viral Reply Templates',
              'AI Tool Comparison',
              'Behind the Scenes',
              'Weekend Roundup'
            ];
            const todayCategory = categories[dayOfWeek];

            // Issue erstellen fuer Copilot
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CONTENT] ${date} - Generate 5 ${todayCategory} Posts`,
              body: `## Auto-Task: Content Generation\n\n**Kategorie:** ${todayCategory}\n**Datum:** ${date}\n\n### Anweisungen:\n1. Lies \`x-lead-machine/CONTENT_CALENDAR.md\` fuer bestehende Posts\n2. Lies \`gold-nuggets/\` fuer Content-Ideen\n3. Erstelle 5 neue Posts in der Kategorie "${todayCategory}"\n4. Format: Hook + Value + CTA\n5. Speichere in \`x-lead-machine/daily/${date}.md\`\n\n### Kontext:\n- Maurice: Elektrotechnikmeister, 16J BMA\n- USP: AI + Brandmeldeanlagen = weltweit einzigartig\n- Gumroad Products: OpenClaw Guide (49EUR), AI Blueprint (79EUR), BMA Guide (149EUR)\n- Ziel: Leads generieren fuer Gumroad + Fiverr\n\n### Output Format:\n\`\`\`\nPost 1:\n[Post Text max 280 chars]\nCTA: [Link/Action]\nBeste Zeit: [HH:MM]\n---\n\`\`\`\n\nLabel: content, auto-generated`,
              labels: ['content', 'auto-generated', 'priority-1']
            });

      - name: "Create Trend Research Issue"
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[RESEARCH] ${date} - Daily Trend Scan`,
              body: `## Auto-Task: Trend Research\n\n**Datum:** ${date}\n\n### Anweisungen:\n1. Recherchiere aktuelle Trends in: AI Automation, OpenClaw, Fire Alarm Systems\n2. Finde 3 trending Topics auf X/Twitter\n3. Identifiziere 2 Competitor-Moves\n4. Speichere in \`docs/research/trends/${date}.md\`\n\n### Focus Areas:\n- AI Agent Frameworks (neue Releases?)\n- OpenClaw Updates/Skills\n- BMA Digitalisierung Deutschland\n- Fiverr AI Service Trends\n\n### Output:\n- 3 Trend-Topics mit Relevanz-Score (1-10)\n- 2 Content-Ideen basierend auf Trends\n- 1 Produkt-Idee basierend auf Trends`,
              labels: ['research', 'auto-generated', 'daily']
            });

  # ============================================
  # JOB 2: MIDDAY - Products + Optimization (12:00 DE)
  # ============================================
  midday-products:
    if: github.event.schedule == '0 10 * * *' || github.event.inputs.task_block == 'ALL' || github.event.inputs.task_block == 'A1'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Product Optimization Issue"
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const dayOfWeek = new Date().getDay();

            // Verschiedene Products an verschiedenen Tagen
            const products = [
              { name: 'OpenClaw Quick Start Guide', price: '49 EUR', file: 'openclaw-quickstart' },
              { name: 'AI Automation Blueprint', price: '79 EUR', file: 'ai-blueprint' },
              { name: 'BMA + AI Integration Guide', price: '149 EUR', file: 'bma-ai-guide' },
              { name: 'Docker Troubleshooting Guide', price: '99 EUR', file: 'docker-guide' },
              { name: 'Agent Swarm Blueprint', price: '199 EUR', file: 'agent-swarm' },
              { name: 'Fiverr Gig Optimization', price: 'Service', file: 'fiverr-gigs' },
              { name: 'Weekly Product Review', price: 'ALL', file: 'weekly-review' }
            ];
            const todayProduct = products[dayOfWeek];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[PRODUCT] ${date} - ${todayProduct.name} erstellen/optimieren`,
              body: `## Auto-Task: Product Work\n\n**Produkt:** ${todayProduct.name}\n**Preis:** ${todayProduct.price}\n**Datum:** ${date}\n\n### Anweisungen:\n1. Lies \`docs/gumroad-products/${todayProduct.file}.md\` (falls existiert)\n2. Lies relevante Gold Nuggets in \`gold-nuggets/\`\n3. Erstelle/erweitere das Produkt-Dokument\n4. Mindestens 2000 Woerter, verkaufsfertig\n5. Speichere in \`docs/gumroad-products/${todayProduct.file}.md\`\n\n### Qualitaets-Checks:\n- [ ] Klarer Nutzen fuer Kaeufer\n- [ ] Actionable Steps (nicht nur Theorie)\n- [ ] Code-Beispiele wo relevant\n- [ ] Preis rechtfertigt Inhalt\n- [ ] CTA am Ende\n\n### Kontext:\nLies COPILOT_BRIEFING.md fuer vollen System-Kontext.`,
              labels: ['product', 'auto-generated', 'revenue']
            });

  # ============================================
  # JOB 3: EVENING - Social + Engagement (18:00 DE)
  # ============================================
  evening-engagement:
    if: github.event.schedule == '0 16 * * *' || github.event.inputs.task_block == 'ALL' || github.event.inputs.task_block == 'A3'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Engagement + Lead Gen Issue"
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[LEADS] ${date} - Lead Research + Outreach Templates`,
              body: `## Auto-Task: Lead Generation\n\n**Datum:** ${date}\n\n### Anweisungen:\n1. Recherchiere 5 potenzielle Leads in diesen Bereichen:\n   - Elektriker/Facility Manager die BMA betreuen\n   - AI Automation Agencies die Kunden suchen\n   - Content Creators die AI Tools bewerben\n2. Erstelle personalisierte Outreach-Templates\n3. Speichere in \`crm/leads/${date}.md\`\n\n### Lead Template:\n\`\`\`\nName: [Name]\nPlatform: [X/LinkedIn/Email]\nWhy Target: [Grund]\nOutreach Message: [Personalisierte Nachricht]\nExpected Response Rate: [%]\nPotential Value: [EUR]\n\`\`\`\n\n### Focus:\n- BMA Markt Deutschland (EUR 2+ Mrd)\n- Fiverr Kunden die AI Services suchen\n- OpenClaw Community Members`,
              labels: ['leads', 'auto-generated', 'revenue']
            });

      - name: "Daily KPI Snapshot"
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const fs = require('fs');

            // Count issues, PRs, Gold Nuggets
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            const openIssues = issues.data.filter(i => i.state === 'open').length;
            const closedIssues = issues.data.filter(i => i.state === 'closed').length;
            const autoGenerated = issues.data.filter(i =>
              i.labels.some(l => l.name === 'auto-generated')
            ).length;

            const kpiContent = `# KPI Snapshot ${date}\n\n` +
              `## GitHub Metrics\n` +
              `- Open Issues: ${openIssues}\n` +
              `- Closed Issues: ${closedIssues}\n` +
              `- Auto-Generated Tasks: ${autoGenerated}\n` +
              `- Completion Rate: ${closedIssues > 0 ? Math.round(closedIssues / (openIssues + closedIssues) * 100) : 0}%\n\n` +
              `## Revenue Status\n` +
              `- Gumroad Products: Check manually\n` +
              `- Fiverr Gigs: Check manually\n` +
              `- Target: EUR 50-100/day\n\n` +
              `## Content Pipeline\n` +
              `- Posts generated today: Check x-lead-machine/daily/\n` +
              `- Gold Nuggets total: Check gold-nuggets/\n\n` +
              `---\n*Auto-generated by GitHub Actions*\n`;

            // Create or update KPI file
            let sha;
            try {
              const existing = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: `docs/kpi/${date}.md`
              });
              sha = existing.data.sha;
            } catch (e) {
              // File doesn't exist yet
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `docs/kpi/${date}.md`,
              message: `[AUTO] KPI Snapshot ${date}`,
              content: Buffer.from(kpiContent).toString('base64'),
              ...(sha ? { sha } : {})
            });

  # ============================================
  # JOB 4: NIGHT - Deep Research (00:00 DE)
  # ============================================
  night-research:
    if: github.event.schedule == '0 22 * * *' || github.event.inputs.task_block == 'ALL' || github.event.inputs.task_block == 'D1'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Deep Research Issue"
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const dayOfWeek = new Date().getDay();

            const researchTopics = [
              'Competitor Analysis: Top 10 AI Automation Tools (Preise, Features, Schwaechen)',
              'Keyword Research: 50 Keywords fuer AI Automation + OpenClaw',
              'Pricing Analysis: Gumroad + Fiverr Durchschnittspreise',
              'BMA Markt Deutschland: Digitalisierung, Software, Trends',
              'OpenClaw Ecosystem: Neue Skills, Updates, Community Wachstum',
              'AI Agent Frameworks: LangChain vs CrewAI vs AutoGen vs OpenClaw',
              'Revenue Optimization: Conversion Rates, Pricing Strategien, Upsell'
            ];
            const todayTopic = researchTopics[dayOfWeek];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[RESEARCH] ${date} - ${todayTopic}`,
              body: `## Auto-Task: Deep Research\n\n**Topic:** ${todayTopic}\n**Datum:** ${date}\n\n### Anweisungen:\n1. Recherchiere gruendlich zum Thema\n2. Erstelle strukturierten Report\n3. Identifiziere 3 actionable Insights\n4. Speichere in \`docs/research/${date}-research.md\`\n\n### Output Format:\n\`\`\`\n# Research Report: ${todayTopic}\n\n## Key Findings\n1. ...\n2. ...\n3. ...\n\n## Data Points\n| Metric | Value | Source |\n\n## Actionable Insights\n1. ...\n2. ...\n3. ...\n\n## Gold Nugget Candidates\n- ...\n\`\`\`\n\n### Kontext:\nLies alle Gold Nuggets in \`gold-nuggets/\` fuer bestehende Erkenntnisse.`,
              labels: ['research', 'auto-generated', 'deep-dive']
            });

  # ============================================
  # JOB 5: WEEKLY - Skills + Code (Sonntag)
  # ============================================
  weekly-skills:
    if: (github.event.schedule == '0 10 * * *' && github.event.schedule != '') || github.event.inputs.task_block == 'B1' || github.event.inputs.task_block == 'B2'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Check if Sunday for weekly tasks"
        id: check_day
        run: |
          if [ "$(date +%u)" = "7" ]; then
            echo "is_sunday=true" >> $GITHUB_OUTPUT
          else
            echo "is_sunday=false" >> $GITHUB_OUTPUT
          fi

      - name: "Weekly Skill Development Issue"
        if: steps.check_day.outputs.is_sunday == 'true' || github.event.inputs.task_block == 'B1' || github.event.inputs.task_block == 'B2'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SKILLS] ${date} - Weekly Skill Development`,
              body: `## Auto-Task: OpenClaw Skill Development\n\n### BMA Expert Skill (B1)\n\`\`\`yaml\nname: bma-expert\nversion: 1.0.0\ndescription: Fire Alarm System Expert - DIN 14675\ncommands:\n  - /bma-check [anlage] - Pruefprotokoll\n  - /bma-wartung [anlage] - Wartungsplan\n  - /bma-doku [projekt] - Dokumentation\n  - /bma-din [norm] - DIN-Norm\n\`\`\`\n\n### SEO Content Engine (B2)\n\`\`\`yaml\nname: seo-content-engine\nversion: 1.0.0\ndescription: Automated SEO content\ncommands:\n  - /seo-article [keyword]\n  - /seo-keywords [niche]\n  - /seo-audit [url]\n\`\`\`\n\n### Aufgabe:\n1. Skill-Code schreiben oder erweitern\n2. Tests hinzufuegen\n3. Dokumentation aktualisieren\n4. PR erstellen\n\nSpeichere in \`openclaw-skills/\``,
              labels: ['skills', 'auto-generated', 'code']
            });
